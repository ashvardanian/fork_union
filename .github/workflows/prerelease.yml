name: Pre-Release

on:
  push:
    branches: ["main-dev"]
  pull_request:
    branches: ["main-dev"]

env:
  GH_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read

jobs:
  versioning:
    name: Update Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Run TinySemVer
        uses: ashvardanian/tinysemver@v2.1.1
        with:
          verbose: "true"
          version-file: "VERSION"
          update-version-in: |
            CMakeLists.txt:^\s*VERSION (\d+\.\d+\.\d+)
            Cargo.toml:^version = "(\d+\.\d+\.\d+)"
            README.md:^\s*GIT_TAG v(\d+\.\d+\.\d+)
            README.md:^\s*fork_union\s*=\s*"(\d+\.\d+\.\d+)"
            README.md:^\s*fork_union\s*=\s*\{\s*version\s*=\s*"(\d+\.\d+\.\d+)"
          update-major-version-in: |
            include/fork_union.hpp:^#define FORK_UNION_VERSION_MAJOR (\d+)
          update-minor-version-in: |
            include/fork_union.hpp:^#define FORK_UNION_VERSION_MINOR (\d+)
          update-patch-version-in: |
            include/fork_union.hpp:^#define FORK_UNION_VERSION_PATCH (\d+)
          dry-run: "true"

  test_ubuntu_gcc:
    name: Ubuntu (GCC)
    runs-on: ubuntu-24.04
    env:
      CC: gcc
      CXX: g++

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build C/C++
        run: |
          sudo apt update
          sudo apt install -y cmake build-essential libomp-dev
          cmake -B build_artifacts -D CMAKE_BUILD_TYPE=RelWithDebInfo
          cmake --build build_artifacts --config RelWithDebInfo
      - name: Test C++
        run: |
          set -euxo pipefail
          build_artifacts/fork_union_test_cpp17
          build_artifacts/fork_union_test_cpp20
          build_artifacts/fork_union_test_cpp23

      - name: Set up Rust
        run: |
          rustup update stable
          rustup default stable
          rustc -vV
      - name: Build Rust
        run: cargo build
      - name: Test Rust
        run: cargo test

  test_ubuntu_clang:
    name: Ubuntu (Clang)
    runs-on: ubuntu-24.04
    env:
      CC: clang
      CXX: clang++

    steps:
      - name: Checkout
        uses: actions/checkout@v5

        # C/C++
      - name: Build C/C++
        run: |
          sudo apt update
          sudo apt install -y cmake build-essential clang
          cmake -B build_artifacts -D CMAKE_BUILD_TYPE=RelWithDebInfo
          cmake --build build_artifacts --config RelWithDebInfo
      - name: Test C++
        run: |
          set -euxo pipefail
          build_artifacts/fork_union_test_cpp17
          build_artifacts/fork_union_test_cpp20
          build_artifacts/fork_union_test_cpp23

      - name: Set up Rust
        run: |
          rustup update stable
          rustup default stable
          rustc -vV
      - name: Build Rust
        run: cargo build
      - name: Test Rust
        run: cargo test

  test_macos:
    name: macOS
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build C/C++
        run: |
          brew update
          brew reinstall cmake
          cmake -B build_artifacts -D CMAKE_BUILD_TYPE=RelWithDebInfo
          cmake --build build_artifacts --config RelWithDebInfo
      - name: Test C++
        run: |
          set -euxo pipefail
          build_artifacts/fork_union_test_cpp17
          build_artifacts/fork_union_test_cpp20
          build_artifacts/fork_union_test_cpp23

      - name: Set up Rust
        run: |
          rustup update stable
          rustup default stable
          rustc -vV
      - name: Build Rust
        run: cargo build
      - name: Test Rust
        run: cargo test

  test_macos_llvm_versions:
    name: macOS LLVM Versions
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        llvm: [16, 17, 18, 19, 20]
        config: [Debug, Release, RelWithDebInfo, MinSizeRel]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install LLVM ${{ matrix.llvm }}
        run: |
          brew update
          brew install llvm@${{ matrix.llvm }}

      - name: Configure (CMake)
        run: |
          cmake -S . -B build_artifacts -D CMAKE_BUILD_TYPE=${{ matrix.config }} -D CMAKE_CXX_COMPILER=$(brew --prefix llvm@${{ matrix.llvm }})/bin/clang++

      - name: Build
        run: cmake --build build_artifacts --config ${{ matrix.config }} --parallel

      - name: Run C++ tests
        run: |
          set -euxo pipefail
          build_artifacts/fork_union_test_cpp17
          build_artifacts/fork_union_test_cpp20
          build_artifacts/fork_union_test_cpp23
  test_windows:
    name: Windows
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build C/C++
        run: |
          choco install cmake
          cmake -B build_artifacts -D CMAKE_BUILD_TYPE=RelWithDebInfo
          cmake --build build_artifacts --config RelWithDebInfo
      - name: List build artifacts
        run: Get-ChildItem -Recurse .\build_artifacts
      - name: Test C++
        run: |
          $ErrorActionPreference = "Stop"
          .\build_artifacts\fork_union_test_cpp17.exe
          .\build_artifacts\fork_union_test_cpp20.exe
          .\build_artifacts\fork_union_test_cpp23.exe

      - name: Set up Rust
        run: |
          rustup update stable
          rustup default stable
          rustc -vV
      - name: Build Rust
        run: cargo build
      - name: Test Rust
        run: cargo test

  test_windows_msvc_matrix:
    name: Windows MSVC Versions
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        toolset: [v143, v142] # VS 2022 and VS 2019
        config: [Debug, Release, RelWithDebInfo, MinSizeRel]
        arch: [x64]
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build C/C++ with MSVC ${{ matrix.toolset }} (${{ matrix.arch }}, ${{ matrix.config }})
        run: |
          choco install cmake
          cmake -B build_artifacts -G "Visual Studio 17 2022" -T ${{ matrix.toolset }} -A ${{ matrix.arch }}
          cmake --build build_artifacts --config ${{ matrix.config }}
      - name: List build artifacts
        run: Get-ChildItem -Recurse .\build_artifacts
      - name: Test C++
        run: |
          $ErrorActionPreference = "Stop"
          .\build_artifacts\fork_union_test_cpp17.exe
          .\build_artifacts\fork_union_test_cpp20.exe
          .\build_artifacts\fork_union_test_cpp23.exe

  test_cross_compile:
    name: Cross-compilation
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: i386
            cc: gcc-multilib
            cxx: g++-multilib
            flags: "-m32"
            emulator: ""
          - arch: armhf
            cc: arm-linux-gnueabihf-gcc
            cxx: arm-linux-gnueabihf-g++
            flags: ""
            emulator: "qemu-arm-static"
          - arch: aarch64
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
            flags: ""
            emulator: "qemu-aarch64-static"
          - arch: s390x
            cc: s390x-linux-gnu-gcc
            cxx: s390x-linux-gnu-g++
            flags: ""
            emulator: "qemu-s390x-static"
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install cross-compilation tools
        run: |
          sudo apt update
          sudo apt install -y cmake qemu-user-static
          case "${{ matrix.arch }}" in
            i386)
              sudo apt install -y gcc-multilib g++-multilib
              ;;
            armhf)
              sudo apt install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
              ;;
            aarch64)
              sudo apt install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              ;;
            s390x)
              sudo apt install -y gcc-s390x-linux-gnu g++-s390x-linux-gnu
              ;;
          esac

      - name: Build C/C++ (${{ matrix.arch }})
        run: |
          cmake -B build_artifacts \
            -D CMAKE_BUILD_TYPE=Release \
            -D CMAKE_C_COMPILER="${{ matrix.cc }}" \
            -D CMAKE_CXX_COMPILER="${{ matrix.cxx }}" \
            -D CMAKE_C_FLAGS="${{ matrix.flags }}" \
            -D CMAKE_CXX_FLAGS="${{ matrix.flags }}"
          cmake --build build_artifacts --config Release

      - name: Test C++ (${{ matrix.arch }})
        run: |
          set -euxo pipefail
          if [ "${{ matrix.arch }}" = "i386" ]; then
            # Native 32-bit execution
            build_artifacts/fork_union_test_cpp17
            build_artifacts/fork_union_test_cpp20
            build_artifacts/fork_union_test_cpp23
          else
            # Emulated execution for other architectures
            ${{ matrix.emulator }} build_artifacts/fork_union_test_cpp17
            ${{ matrix.emulator }} build_artifacts/fork_union_test_cpp20
            ${{ matrix.emulator }} build_artifacts/fork_union_test_cpp23
          fi
